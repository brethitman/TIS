<div class="space-y-8">
  <div class="p-4 bg-blue-50 rounded-lg">
    <h2 class="text-xl font-semibold text-blue-800 mb-3">Gestión de Áreas</h2>
    <app-crear-area
      *ngIf="idOlimpiada"
      [idOlimpiada]="idOlimpiada"
      class="block mb-4"
      (areaCreada)="cargarAreas()"
    ></app-crear-area>
    <p class="text-gray-600">Desde aquí podrás crear nuevas áreas para la olimpiada.</p>
  </div>

  <div class="p-6 container mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-blue-800">Áreas y Categorías Existentes</h1>

    <div *ngIf="cargando" class="text-center text-blue-600 animate-pulse">
      <i class="fas fa-spinner fa-spin mr-2"></i>Cargando áreas...
    </div>

    <div *ngIf="errorCarga" class="p-4 bg-red-100 text-red-700 rounded-lg text-center mb-4 border border-red-200">
      ⚠️ {{ errorCarga }}
    </div>

    <div *ngIf="!cargando && !errorCarga">
      <div *ngIf="areas.length === 0" class="text-center text-gray-500 p-8 border-2 border-dashed rounded-xl">
        No se han encontrado áreas registradas
      </div>

      <div *ngIf="areas.length > 0" class="space-y-8">
        <div *ngFor="let area of areas" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow">
          <div class="mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">{{ area.nombre_area }}</h2>
            </div>

          <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-800">Niveles asociados</h3>
              <button
                (click)="toggleFormulario(area.id_area)"
                class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors text-sm"
              >
                {{ areaActivaId === area.id_area ? 'Cerrar Formulario' : 'Agregar Niveles' }}
              </button>
            </div>

            <div *ngIf="errores.length > 0 && areaActivaId === area.id_area" class="mb-4 p-3 bg-red-100 text-red-700 rounded-lg border border-red-200">
              <p class="font-semibold mb-2">Errores al guardar niveles:</p>
               <ul class="list-disc pl-4">
                  <li *ngFor="let error of errores" class="mb-1 last:mb-0">{{ error }}</li>
               </ul>
            </div>

            <div *ngIf="successMessage && areaActivaId === area.id_area" class="mb-4 p-3 bg-green-100 text-green-700 rounded-lg border border-green-200">
              ✅ {{ successMessage }}
            </div>


            <div *ngIf="areaActivaId !== area.id_area">
                <div *ngIf="!area.nivel_categorias?.length" class="text-gray-500 italic py-2">
                    No se han definido niveles para esta área.
                </div>

                <div *ngIf="area.nivel_categorias?.length" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div *ngFor="let nivel of area.nivel_categorias" class="bg-gray-50 p-4 rounded-lg border border-gray-100 hover:bg-white transition-colors">
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">{{ nivel.nombre_nivel }}</h4>

                    <div class="space-y-1.5 text-sm">
                      <p *ngIf="nivel.descripcion" class="text-gray-600 italic">
                        {{ nivel.descripcion }}
                      </p>
                       <div class="flex justify-between">
                         <span class="text-gray-600">Grados:</span>
                         <span class="font-medium text-gray-700">
                          <!-- {{ nivel.gradoIniCat }} - {{ nivel.gradoFinCat }}                          -->

                         </span>
                       </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Fecha examen:</span>
                        <span class="font-medium text-gray-700">
                          {{ nivel.fecha_examen | date:'dd/MM/yyyy' }}
                        </span>
                      </div>
                      <div class="flex justify-between">
                        <span class="text-gray-600">Costo:</span>
                        <span class="font-medium text-gray-700">
                          {{ nivel.costo | currency:'USD':'symbol':'1.2-2' }}
                        </span>
                      </div>
                       <div class="flex justify-between">
                         <span class="text-gray-600">Habilitación:</span>
                         <span class="font-medium text-gray-700">
                            {{ getEstadoTexto(nivel.habilitacion) }}
                         </span>
                       </div>
                      </div>
                  </div>
                </div>
            </div>


            <div *ngIf="areaActivaId === area.id_area" class="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
               <h4 class="text-lg font-semibold text-gray-800 mb-4">Agregar Nuevos Niveles a {{ area.nombre_area }}</h4>

               <div *ngIf="formErrors.length > 0" class="mb-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg border border-yellow-200">
                 <p class="font-semibold mb-2">Errores en el nivel actual:</p>
                  <ul class="list-disc pl-4">
                     <li *ngFor="let error of formErrors" class="mb-1 last:mb-0">{{ error }}</li>
                  </ul>
               </div>

               <div class="space-y-4 mb-6">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                       <label for="nombre_nivel_{{area.id_area}}" class="block text-sm font-medium text-gray-700">Nombre del Nivel:</label>
                       <input type="text" id="nombre_nivel_{{area.id_area}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                              [(ngModel)]="currentNewLevel.nombre_nivel" name="nombre_nivel_{{area.id_area}}">
                    </div>
                    <div>
                       <label for="fecha_examen_{{area.id_area}}" class="block text-sm font-medium text-gray-700">Fecha del Examen:</label>
                       <input type="date" id="fecha_examen_{{area.id_area}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                              [(ngModel)]="currentNewLevel.fecha_examen" name="fecha_examen_{{area.id_area}}">
                    </div>
                 </div>

                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                       <label for="gradoIniCat_{{area.id_area}}" class="block text-sm font-medium text-gray-700">Grado Inicial:</label>
                       <input type="text" id="gradoIniCat_{{area.id_area}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                              [(ngModel)]="currentNewLevel.gradoIniCat" name="gradoIniCat_{{area.id_area}}">
                    </div>
                     <div>
                       <label for="gradoFinCat_{{area.id_area}}" class="block text-sm font-medium text-gray-700">Grado Final:</label>
                       <input type="text" id="gradoFinCat_{{area.id_area}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                              [(ngModel)]="currentNewLevel.gradoFinCat" name="gradoFinCat_{{area.id_area}}">
                    </div>
                    <div>
                       <label for="costo_{{area.id_area}}" class="block text-sm font-medium text-gray-700">Costo:</label>
                       <input type="number" id="costo_{{area.id_area}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                              [(ngModel)]="currentNewLevel.costo" name="costo_{{area.id_area}}" min="0">
                    </div>
                 </div>

                 <div>
                     <label for="descripcion_{{area.id_area}}" class="block text-sm font-medium text-gray-700">Descripción (Opcional):</label>
                     <textarea id="descripcion_{{area.id_area}}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               [(ngModel)]="currentNewLevel.descripcion" name="descripcion_{{area.id_area}}"></textarea>
                 </div>

                 <div class="flex items-center">
                   <input id="habilitacion_{{area.id_area}}" name="habilitacion_{{area.id_area}}" type="checkbox"
                          class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                          [(ngModel)]="currentNewLevel.habilitacion">
                   <label for="habilitacion_{{area.id_area}}" class="ml-2 block text-sm text-gray-900">Habilitado</label>
                 </div>

               </div>

               <button (click)="agregarNivelLocal()"
                       class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75 transition-colors text-sm"
                       [disabled]="!validarCurrentNewLevel()">
                 Agregar Nivel a la Lista
               </button>

               <hr class="my-6 border-gray-300">

               <h4 class="text-lg font-semibold text-gray-800 mb-4">Niveles a Agregar ({{ newLevelsForArea.length }})</h4>
               <div *ngIf="newLevelsForArea.length > 0">
                 <ul class="space-y-3">
                   <li *ngFor="let nivel of newLevelsForArea; let i = index"
                       class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center hover:bg-gray-50 transition-colors text-sm">
                     <div class="text-sm">
                       <p class="font-semibold text-gray-800">{{ nivel.nombre_nivel }}</p>
                       <p class="text-gray-600">Grados: {{ nivel.gradoIniCat }} - {{ nivel.gradoFinCat }}</p>
                       <p class="text-gray-600">Fecha: {{ nivel.fecha_examen | date:'dd/MM/yyyy' }}</p>
                       <p class="text-gray-600">Costo: {{ nivel.costo | currency:'USD':'symbol':'1.2-2' }}</p>
                       <p class="text-gray-600">Estado: {{ getEstadoTexto(nivel.habilitacion) }}</p>
                       </div>
                     <button (click)="removerNivelLocal(i)"
                             class="text-red-600 hover:text-red-800 text-sm font-semibold ml-4">
                       Remover
                     </button>
                   </li>
                 </ul>
                 <button (click)="enviarNiveles()"
                         class="mt-6 w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors text-center"
                         [disabled]="newLevelsForArea.length === 0 || enviando">
                   <span *ngIf="enviando" class="animate-spin inline-block w-4 h-4 border-[3px] border-current border-t-transparent text-white rounded-full mr-2"></span>
                   {{ enviando ? 'Guardando Niveles...' : 'Guardar Todos los Niveles' }}
                 </button>
               </div>
               <div *ngIf="newLevelsForArea.length === 0" class="text-center text-gray-500 italic py-4 border-2 border-dashed rounded-lg">
                 Agregue niveles usando el formulario de arriba para guardarlos.
               </div>

            </div>
            </div>
          </div>
      </div>
    </div>
  </div>
</div>
